{% extends "base.html" %}
{% block title %}View Quality Records - TestingHub Portal{% endblock %}
{% block content %}
<style>
    .quality-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 2rem;
        color: white;
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        margin-bottom: 2rem;
    }
    
    .filter-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .records-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dd-badge-low {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .dd-badge-medium {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .dd-badge-high {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .stats-row {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 0.5rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="quality-header">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb bg-transparent mb-0">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('home.index') }}" class="text-white">
                        <i class="bi bi-house"></i> Home
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('quality.main') }}" class="text-white">Quality</a>
                </li>
                <li class="breadcrumb-item text-white active">View Records</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-list-check"></i> Quality Records
                </h2>
                <p class="mb-0 lead">View and manage your quality records</p>
            </div>
            <a href="{{ url_for('quality.main') }}" class="btn btn-light btn-lg">
                <i class="bi bi-plus-circle"></i> Create New
            </a>
        </div>
    </div>

    <!-- Statistics Summary -->
    {% if records %}
    <div class="stats-row">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <div class="stat-value">{{ records|length }}</div>
                    <div class="stat-label">Total Records</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <div class="stat-value">{{ trial_ids|length if trial_ids else 0 }}</div>
                    <div class="stat-label">Unique Trials</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <div class="stat-value">{{ phases|length if phases else 0 }}</div>
                    <div class="stat-label">Phases</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <div class="stat-value">{{ types|length if types else 0 }}</div>
                    <div class="stat-label">Record Types</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="filter-card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-funnel-fill"></i> Filter Records
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-tag"></i> Trial ID
                        </label>
                        <select class="form-select" name="trial_id" onchange="this.form.submit()">
                            <option value="All">All Trials</option>
                            {% for tid in trial_ids %}
                            <option value="{{ tid }}" {% if filters.trial_id == tid %}selected{% endif %}>
                                {{ tid }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-layers"></i> Phase
                        </label>
                        <select class="form-select" name="phase" onchange="this.form.submit()">
                            <option value="All">All Phases</option>
                            {% for p in phases %}
                            <option value="{{ p }}" {% if filters.phase == p %}selected{% endif %}>
                                {{ p }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-text"></i> Type
                        </label>
                        <select class="form-select" name="type" onchange="this.form.submit()">
                            <option value="All">All Types</option>
                            {% for t in types %}
                            <option value="{{ t }}" {% if filters.type == t %}selected{% endif %}>
                                {{ t }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Records Table -->
    <div class="records-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Quality Records List ({{ records|length }})
            </h5>
        </div>
        <div class="card-body">
            {% if records %}
            <div class="table-responsive">
                <table class="table table-hover table-sm" id="qualityRecordsTable">
                    <thead class="table-light">
                        <tr>
                            <th><i class="bi bi-tag"></i> Trial ID</th>
                            <th><i class="bi bi-layers"></i> Phase</th>
                            <th><i class="bi bi-heart-pulse"></i> Therapeutic</th>
                            <th><i class="bi bi-file-text"></i> Type</th>
                            <th><i class="bi bi-flag"></i> Trial Round</th>
                            <th><i class="bi bi-arrow-repeat"></i> Req Round</th>
                            <th><i class="bi bi-list-ol"></i> Req</th>
                            <th><i class="bi bi-exclamation-triangle"></i> Fail</th>
                            <th><i class="bi bi-graph-up"></i> DD%</th>
                            <th><i class="bi bi-person"></i> Created By</th>
                            <th><i class="bi bi-gear"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>
                                <span class="badge bg-info">{{ record.trial_id }}</span>
                            </td>
                            <td><small>{{ record.phase }}</small></td>
                            <td><small>{{ record.therapeutic_area or 'N/A' }}</small></td>
                            <td><span class="badge bg-primary">{{ record.type_of_requirement }}</span></td>
                            <td><span class="badge bg-secondary">R{{ record.current_round }}</span></td>
                            <td><span class="badge bg-success">{{ record.type_of_requirement[:1] }}{{ record.requirement_round or 1 }}</span></td>
                            <td><strong>{{ record.total_requirements }}</strong></td>
                            <td>
                                <span class="badge bg-danger">{{ record.total_failures }}</span>
                            </td>
                            <td>
                                {% set dd = record.defect_density if record.defect_density else 0 %}
                                {% if dd < 10 %}
                                    <span class="dd-badge-low">{{ "%.1f"|format(dd) }}%</span>
                                {% elif dd < 25 %}
                                    <span class="dd-badge-medium">{{ "%.1f"|format(dd) }}%</span>
                                {% else %}
                                    <span class="dd-badge-high">{{ "%.1f"|format(dd) }}%</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="bi bi-person-circle"></i> {{ record.created_by }}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('quality.view_single', record_id=record.record_id) }}" 
                                       class="btn btn-sm btn-info" 
                                       title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    
                                    {% if user.role in ['superuser', 'admin', 'manager'] or record.created_by == user.username %}
                                    <a href="{{ url_for('quality.edit', record_id=record.record_id) }}" 
                                       class="btn btn-sm btn-warning" 
                                       title="Edit Record">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if user.role in ['superuser', 'admin'] or record.created_by == user.username %}
                                    <form method="POST" 
                                          action="{{ url_for('quality.delete_route', record_id=record.record_id) }}" 
                                          style="display: inline;">
                                        <button type="submit" 
                                                class="btn btn-sm btn-danger" 
                                                title="Delete Record"
                                                onclick="return confirm('Are you sure you want to delete this record? This action cannot be undone.')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info shadow-sm">
                <div class="d-flex align-items-center">
                    <i class="bi bi-inbox" style="font-size: 3rem; margin-right: 1rem;"></i>
                    <div>
                        <h5 class="mb-1">No Quality Records Found</h5>
                        <p class="mb-0">
                            {% if filters.trial_id != 'All' or filters.phase != 'All' or filters.type != 'All' %}
                                No records match your current filters. Try adjusting your filter criteria.
                            {% else %}
                                You haven't created any quality records yet. Click "Create New" to get started!
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Clear all filters
function clearFilters() {
    window.location.href = "{{ url_for('quality.view_records') }}";
}

// Initialize DataTable
$(document).ready(function() {
    var table = $('#qualityRecordsTable');
    if (table.length) {
        // Destroy if already initialized
        if ($.fn.DataTable.isDataTable('#qualityRecordsTable')) {
            table.DataTable().destroy();
        }
        
        // Initialize fresh
        table.DataTable({
            order: [[4, 'desc'], [5, 'desc']],  // Sort by Trial Round, then Req Round
            pageLength: 25,
            responsive: true,
            language: {
                search: "Search records:",
                lengthMenu: "Show _MENU_ records per page",
                info: "Showing _START_ to _END_ of _TOTAL_ records",
                infoEmpty: "No records available",
                infoFiltered: "(filtered from _MAX_ total records)"
            },
            columnDefs: [
                { orderable: false, targets: -1 }  // Disable sorting on Actions column
            ]
        });
    }
});
</script>
{% endblock %}